name: Smoke Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  smoke:
    runs-on: ubuntu-latest

    env:
      NODE_ENV: production
      DATABASE_URL: postgresql://test:test@localhost:5432/ggvibe_test
      OIDC_CLIENT_ID: test-oidc-client-id
      ISSUER_URL: https://accounts.example.com/oidc
      PORT: 3000
      NEXT_PUBLIC_APP_URL: http://localhost:3000
      CHAT_MOCK_RESPONSE: "true"
      NEXT_PUBLIC_FIREBASE_API_KEY: demo-key
      NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: demo.firebaseapp.com
      NEXT_PUBLIC_FIREBASE_PROJECT_ID: demo-project
      NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET: demo-project.firebasestorage.app
      NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: "123456789"
      NEXT_PUBLIC_FIREBASE_APP_ID: 1:123456789:web:abcdef

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: ggvibe_test
        options: >-
          --health-cmd "pg_isready -U test -d ggvibe_test"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
        ports:
          - 5432:5432

    defaults:
      run:
        shell: bash
        working-directory: ggvibe

    steps:
      # NOTE: If your org blocks GitHub-owned actions, follow CI_TROUBLESHOOTING.md (PATH 1).
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: ggvibe/package-lock.json

      - name: Generate ephemeral SESSION_SECRET
        run: echo "SESSION_SECRET=$(openssl rand -hex 32)" >> "$GITHUB_ENV"

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Start application in background
        run: |
          set -euo pipefail
          npm run start > ../server.log 2>&1 &
          echo "APP_PID=$!" >> "$GITHUB_ENV"

      - name: Wait for server readiness
        run: |
          set -euo pipefail
          for i in $(seq 1 60); do
            if curl -fsS "http://localhost:${PORT}/api/health" >/dev/null 2>&1; then
              exit 0
            fi
            sleep 1
          done
          echo "Server did not become ready"
          tail -n 200 ../server.log || true
          exit 1

      - name: Verify route contract
        run: |
          set -euo pipefail

          ROOT_STATUS="$(curl -s -o /tmp/root.out -w "%{http_code}" "http://localhost:${PORT}/")"
          test "$ROOT_STATUS" = "200"

          ROBOTS_STATUS="$(curl -s -o /tmp/robots.out -w "%{http_code}" "http://localhost:${PORT}/robots.txt")"
          test "$ROBOTS_STATUS" = "200"
          grep -q "Disallow: /payouts" /tmp/robots.out

          MCP_STATUS="$(curl -s -o /tmp/mcp.out -w "%{http_code}" "http://localhost:${PORT}/mcp")"
          test "$MCP_STATUS" = "200"
          grep -q '"tools"' /tmp/mcp.out
          grep -q '"endpoints"' /tmp/mcp.out

          MARKET_STATUS="$(curl -s -o /tmp/market.out -w "%{http_code}" "http://localhost:${PORT}/market")"
          test "$MARKET_STATUS" = "200"

          MARKET_API_STATUS="$(curl -s -o /tmp/market-api.out -w "%{http_code}" "http://localhost:${PORT}/api/market/items")"
          test "$MARKET_API_STATUS" = "200"

          PAYOUTS_STATUS="$(curl -s -o /tmp/payouts.out -D /tmp/payouts.headers -w "%{http_code}" "http://localhost:${PORT}/payouts")"
          if [ "$PAYOUTS_STATUS" != "307" ] && [ "$PAYOUTS_STATUS" != "308" ]; then
            echo "Expected /payouts to redirect when anonymous, got $PAYOUTS_STATUS"
            exit 1
          fi

          PAYOUTS_API_STATUS="$(curl -s -o /tmp/payouts-api.out -D /tmp/payouts-api.headers -w "%{http_code}" "http://localhost:${PORT}/api/payouts")"
          if [ "$PAYOUTS_API_STATUS" != "401" ] && [ "$PAYOUTS_API_STATUS" != "403" ]; then
            echo "Expected /api/payouts to be private (401/403), got $PAYOUTS_API_STATUS"
            exit 1
          fi
          grep -qi "^X-Robots-Tag: noindex, nofollow" /tmp/payouts-api.headers
          grep -Eqi "^Cache-Control: .*no-store" /tmp/payouts-api.headers

          PAYOUTS_TXT_STATUS="$(curl -s -o /tmp/payouts-txt.out -w "%{http_code}" "http://localhost:${PORT}/payouts.txt")"
          test "$PAYOUTS_TXT_STATUS" = "404"

          LOGIN_GET_STATUS="$(curl -s -o /tmp/login-get.out -w "%{http_code}" "http://localhost:${PORT}/api/login")"
          test "$LOGIN_GET_STATUS" = "405"

      - name: Verify forbidden-term scans
        run: |
          set -euo pipefail
          cd ..
          ! rg -n "stripe|paystack|checkout session|payment intent|webhook|pay link|payment provider" . --glob '!**/node_modules/**'
          ! rg -n "replit|REPLIT_|REPL_|replit_integration_files" . --glob '!**/node_modules/**'

      - name: Cleanup
        if: always()
        run: |
          set +e
          if [ -n "${APP_PID:-}" ]; then
            kill "${APP_PID}" || true
          fi
          tail -n 200 ../server.log || true
