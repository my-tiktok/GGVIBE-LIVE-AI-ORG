name: Smoke Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  smoke:
    runs-on: ubuntu-latest
    
    env:
      NODE_ENV: production
      SESSION_SECRET: test-session-secret-32-chars-minimum-here12
      DATABASE_URL: postgresql://test:test@localhost:5432/ggvibe_test
      REPL_ID: test-repl-id
      NEXT_PUBLIC_APP_URL: http://localhost:3000
      PORT: 3000

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: ggvibe_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: 'ggvibe/package-lock.json'
    
    - name: Install root dependencies
      run: npm install --prefix . --legacy-peer-deps
    
    - name: Install ggvibe dependencies
      run: npm install --prefix ggvibe --legacy-peer-deps
    
    - name: Build application
      run: npm run build --prefix ggvibe
    
    - name: Start application in background
      run: |
        cd ggvibe
        npm start &
        APP_PID=$!
        sleep 5
        echo "APP_PID=$APP_PID" >> $GITHUB_ENV
    
    - name: Verify OpenAI challenge endpoint
      run: |
        echo "Testing: /.well-known/openai-apps-challenge"
        CHALLENGE=$(curl -s http://localhost:3000/.well-known/openai-apps-challenge)
        if [ -z "$CHALLENGE" ]; then
          echo "❌ FAILED: Challenge endpoint returned empty"
          exit 1
        fi
        echo "✅ PASSED: Got challenge token: $CHALLENGE"
    
    - name: Verify health endpoint
      run: |
        echo "Testing: /api/health"
        HEALTH=$(curl -s http://localhost:3000/api/health)
        echo "Response: $HEALTH"
        if ! echo "$HEALTH" | grep -q '"status"'; then
          echo "❌ FAILED: Health endpoint missing status field"
          exit 1
        fi
        if ! echo "$HEALTH" | grep -q '"appUrlConfigured"'; then
          echo "❌ FAILED: Health endpoint missing appUrlConfigured field"
          exit 1
        fi
        echo "✅ PASSED: Health endpoint OK"
    
    - name: Verify MCP endpoint
      run: |
        echo "Testing: /mcp"
        MCP=$(curl -s http://localhost:3000/mcp)
        echo "Response: $MCP"
        if ! echo "$MCP" | grep -q '"name"'; then
          echo "❌ FAILED: MCP endpoint missing name field"
          exit 1
        fi
        if ! echo "$MCP" | grep -q '"endpoints"'; then
          echo "❌ FAILED: MCP endpoint missing endpoints field"
          exit 1
        fi
        echo "✅ PASSED: MCP endpoint OK"
    
    - name: Test chat stream unauthorized
      run: |
        echo "Testing: /api/v1/chat/stream (unauthorized)"
        RESPONSE=$(curl -s -w "\n%{http_code}" -X POST http://localhost:3000/api/v1/chat/stream)
        STATUS=$(echo "$RESPONSE" | tail -n1)
        if [ "$STATUS" != "401" ]; then
          echo "❌ FAILED: Expected 401, got $STATUS"
          exit 1
        fi
        echo "✅ PASSED: Unauthorized request correctly returned 401"
    
    - name: Test chat stream authorized
      run: |
        echo "Testing: /api/v1/chat/stream (authorized)"
        RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
          -H "Authorization: Bearer test-token-12345" \
          -H "Content-Type: application/json" \
          http://localhost:3000/api/v1/chat/stream)
        STATUS=$(echo "$RESPONSE" | tail -n1)
        if [ "$STATUS" != "200" ]; then
          echo "❌ FAILED: Expected 200, got $STATUS"
          exit 1
        fi
        echo "✅ PASSED: Authorized streaming request returned 200"
    
    - name: Verify no rewrites intercept protected paths
      run: |
        echo "Verifying next.config.mjs does not contain rewrites for protected paths..."
        cd ggvibe
        if grep -q "\.well-known.*destination" next.config.mjs; then
          echo "❌ FAILED: Found rewrites for .well-known paths"
          exit 1
        fi
        if grep -q "/api/health.*destination" next.config.mjs; then
          echo "❌ FAILED: Found rewrites for /api/health"
          exit 1
        fi
        if grep -q "/mcp.*destination" next.config.mjs; then
          echo "❌ FAILED: Found rewrites for /mcp"
          exit 1
        fi
        echo "✅ PASSED: No protected paths are rewritten"
    
    - name: Cleanup
      if: always()
      run: |
        if [ ! -z "$APP_PID" ]; then
          kill $APP_PID || true
        fi
